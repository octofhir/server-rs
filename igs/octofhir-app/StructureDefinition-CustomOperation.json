{
  "resourceType": "StructureDefinition",
  "id": "CustomOperation",
  "url": "http://octofhir.io/StructureDefinition/CustomOperation",
  "name": "CustomOperation",
  "title": "Custom Operation Resource",
  "status": "active",
  "fhirVersion": "4.0.1",
  "kind": "logical",
  "abstract": false,
  "type": "CustomOperation",
  "baseDefinition": "http://hl7.org/fhir/StructureDefinition/DomainResource",
  "derivation": "specialization",
  "description": "A CustomOperation defines a custom API endpoint with configurable behavior (proxy, SQL, FHIRPath, app backend, or custom handler).",
  "differential": {
    "element": [
      {
        "id": "CustomOperation",
        "path": "CustomOperation",
        "short": "Custom API operation definition",
        "definition": "Defines a custom API endpoint with its path, method, and implementation."
      },
      {
        "id": "CustomOperation.app",
        "path": "CustomOperation.app",
        "short": "Parent application",
        "definition": "Reference to the App that contains this operation",
        "min": 1,
        "max": "1",
        "type": [
          {
            "code": "Reference",
            "targetProfile": ["http://octofhir.io/StructureDefinition/App"]
          }
        ]
      },
      {
        "id": "CustomOperation.path",
        "path": "CustomOperation.path",
        "short": "Relative URL path",
        "definition": "Path relative to App.basePath (e.g., /users/:id)",
        "comment": "Supports path parameters like :id, :resourceId",
        "min": 1,
        "max": "1",
        "type": [{ "code": "string" }]
      },
      {
        "id": "CustomOperation.method",
        "path": "CustomOperation.method",
        "short": "HTTP method",
        "definition": "HTTP method for this operation (GET, POST, PUT, DELETE, PATCH)",
        "min": 1,
        "max": "1",
        "type": [{ "code": "code" }],
        "binding": {
          "strength": "required",
          "valueSet": "http://octofhir.io/ValueSet/http-methods"
        }
      },
      {
        "id": "CustomOperation.type",
        "path": "CustomOperation.type",
        "short": "Operation type",
        "definition": "Type of operation implementation: proxy | sql | fhirpath | handler | app",
        "min": 1,
        "max": "1",
        "type": [{ "code": "code" }],
        "binding": {
          "strength": "required",
          "valueSet": "http://octofhir.io/ValueSet/operation-types"
        }
      },
      {
        "id": "CustomOperation.proxy",
        "path": "CustomOperation.proxy",
        "short": "Proxy configuration",
        "definition": "Configuration for proxy-type operations",
        "condition": ["type == 'proxy'"],
        "min": 0,
        "max": "1",
        "type": [{ "code": "BackboneElement" }]
      },
      {
        "id": "CustomOperation.proxy.url",
        "path": "CustomOperation.proxy.url",
        "short": "Target URL",
        "definition": "Full URL to proxy requests to",
        "min": 1,
        "max": "1",
        "type": [{ "code": "url" }]
      },
      {
        "id": "CustomOperation.proxy.timeout",
        "path": "CustomOperation.proxy.timeout",
        "short": "Timeout in seconds",
        "definition": "Request timeout in seconds (default: 30)",
        "min": 0,
        "max": "1",
        "type": [{ "code": "integer" }]
      },
      {
        "id": "CustomOperation.proxy.headers",
        "path": "CustomOperation.proxy.headers",
        "short": "Additional headers",
        "definition": "Headers to add to proxied requests",
        "min": 0,
        "max": "*",
        "type": [{ "code": "BackboneElement" }]
      },
      {
        "id": "CustomOperation.proxy.headers.name",
        "path": "CustomOperation.proxy.headers.name",
        "short": "Header name",
        "min": 1,
        "max": "1",
        "type": [{ "code": "string" }]
      },
      {
        "id": "CustomOperation.proxy.headers.value",
        "path": "CustomOperation.proxy.headers.value",
        "short": "Header value",
        "min": 1,
        "max": "1",
        "type": [{ "code": "string" }]
      },
      {
        "id": "CustomOperation.sql",
        "path": "CustomOperation.sql",
        "short": "SQL query",
        "definition": "SQL query to execute (for type = sql)",
        "comment": "Use parameterized queries to prevent SQL injection",
        "condition": ["type == 'sql'"],
        "min": 0,
        "max": "1",
        "type": [{ "code": "string" }]
      },
      {
        "id": "CustomOperation.fhirpath",
        "path": "CustomOperation.fhirpath",
        "short": "FHIRPath expression",
        "definition": "FHIRPath expression to evaluate (for type = fhirpath)",
        "condition": ["type == 'fhirpath'"],
        "min": 0,
        "max": "1",
        "type": [{ "code": "string" }]
      },
      {
        "id": "CustomOperation.handler",
        "path": "CustomOperation.handler",
        "short": "Handler identifier",
        "definition": "Identifier for a registered custom handler (for type = handler)",
        "condition": ["type == 'handler'"],
        "min": 0,
        "max": "1",
        "type": [{ "code": "string" }]
      },
      {
        "id": "CustomOperation.active",
        "path": "CustomOperation.active",
        "short": "Whether the operation is active",
        "definition": "If false, requests to this operation return 404",
        "min": 1,
        "max": "1",
        "type": [{ "code": "boolean" }]
      },
      {
        "id": "CustomOperation.public",
        "path": "CustomOperation.public",
        "short": "Public operation (no auth)",
        "definition": "If true, no authentication required for this operation",
        "min": 0,
        "max": "1",
        "type": [{ "code": "boolean" }]
      },
      {
        "id": "CustomOperation.description",
        "path": "CustomOperation.description",
        "short": "Description",
        "definition": "Human-readable description of what this operation does",
        "min": 0,
        "max": "1",
        "type": [{ "code": "string" }]
      },
      {
        "id": "CustomOperation.policy",
        "path": "CustomOperation.policy",
        "short": "Access policy",
        "definition": "Access control configuration for this operation (used with type=app)",
        "min": 0,
        "max": "1",
        "type": [{ "code": "BackboneElement" }]
      },
      {
        "id": "CustomOperation.policy.authType",
        "path": "CustomOperation.policy.authType",
        "short": "Authentication type",
        "definition": "Authentication method: 'forward' (OAuth token, default) or 'app' (X-App-Secret header)",
        "comment": "Forward auth uses standard OAuth bearer tokens from the Authorization header. App auth requires the X-App-Secret header with the app's secret for machine-to-machine authentication.",
        "min": 0,
        "max": "1",
        "type": [{ "code": "code" }],
        "binding": {
          "strength": "required",
          "valueSet": "http://octofhir.io/ValueSet/auth-types"
        }
      },
      {
        "id": "CustomOperation.policy.roles",
        "path": "CustomOperation.policy.roles",
        "short": "Required roles",
        "definition": "User must have one of these roles",
        "min": 0,
        "max": "*",
        "type": [{ "code": "string" }]
      },
      {
        "id": "CustomOperation.policy.scopes",
        "path": "CustomOperation.policy.scopes",
        "short": "Required SMART scopes",
        "definition": "Token must have one of these scopes (supports wildcards)",
        "min": 0,
        "max": "*",
        "type": [{ "code": "string" }]
      },
      {
        "id": "CustomOperation.policy.compartment",
        "path": "CustomOperation.policy.compartment",
        "short": "Compartment restriction",
        "definition": "Restrict to user's compartment: patient, practitioner",
        "min": 0,
        "max": "1",
        "type": [{ "code": "code" }]
      },
      {
        "id": "CustomOperation.policy.script",
        "path": "CustomOperation.policy.script",
        "short": "Custom policy script",
        "definition": "QuickJS script for complex access control",
        "min": 0,
        "max": "1",
        "type": [{ "code": "string" }]
      },
      {
        "id": "CustomOperation.includeRawBody",
        "path": "CustomOperation.includeRawBody",
        "short": "Include raw request body bytes",
        "definition": "Whether to include raw request body bytes (base64-encoded) in AppOperationRequest. Only applicable for type='app' operations. Useful for binary data, file uploads, or when the app needs the original bytes.",
        "comment": "When true, the raw body will be base64-encoded and included in the rawBody field of AppOperationRequest. This allows App backends to access the original request bytes for binary data processing, signature verification, or other scenarios where the parsed JSON is insufficient.",
        "condition": ["type == 'app'"],
        "min": 0,
        "max": "1",
        "type": [{ "code": "boolean" }]
      }
    ]
  }
}
