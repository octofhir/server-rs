# OctoFHIR Server Configuration

[server]
# Network settings
host = "0.0.0.0"
port = 8888
# Timeouts in milliseconds
read_timeout_ms = 15000
write_timeout_ms = 15000
# Max request body size in bytes (1 MiB)
body_limit_bytes = 1048576

[storage]
# PostgreSQL storage configuration (required)
#
# Two configuration modes are supported:
# 1. URL mode: Set `url` to a full connection string
# 2. Separate options: Set host, port, user, password, database individually
#
# If `url` is set, it takes precedence over individual options.
[storage.postgres]
# Option 1: Full connection URL (takes precedence if set)
# url = "postgres://postgres:postgres@localhost:5450/octofhir"

# Option 2: Separate connection options
host = "localhost"
port = 5450
user = "postgres"
password = "postgres"
database = "octofhir"

# Connection pool settings
pool_size = 20
connect_timeout_ms = 10000
idle_timeout_ms = 60000

[fhir]
# Supported: R4 (default), R4B, R5, R6
version = "R4"

[validation]
# Allow clients to skip validation via X-Skip-Validation header
# Useful for bulk imports, testing, or high-performance scenarios
allow_skip_validation = true

[search]
# Default and max page sizes
default_count = 10
max_count = 100

[packages]
# Base directory for canonical manager storage (packages/, index/, cache/ will be created here)
path = ".fhir"
# Load canonical packages by id#version (or path via table form in custom files)
load = [
  "hl7.fhir.r4.core#4.0.1"
]

[logging]
# trace | debug | info | warn | error | off
level = "info"

[otel]
# Enable OpenTelemetry tracing export
enabled = false
# Endpoint URL, e.g., "http://localhost:4318"
endpoint = ""
# Optional sampling ratio between 0.0 and 1.0
sample_ratio = 0.0

# =============================================================================
# Authentication & Authorization (SMART on FHIR / OAuth 2.0)
# =============================================================================

[auth]
# Issuer URL for tokens (should match your server's public URL)
issuer = "http://localhost:8888"

[auth.oauth]
# OAuth 2.0 token lifetimes
authorization_code_lifetime = "10m"
access_token_lifetime = "1h"
refresh_token_lifetime = "90d"
# Rotate refresh tokens on each use (security best practice)
refresh_token_rotation = true
# Allowed OAuth grant types
grant_types = ["authorization_code", "client_credentials", "refresh_token"]

[auth.smart]
# SMART on FHIR launch modes
launch_ehr_enabled = true
launch_standalone_enabled = true
# Client types
public_clients_allowed = true
confidential_symmetric_allowed = true
confidential_asymmetric_allowed = true
# Token features
refresh_tokens_enabled = true
openid_enabled = true
# Dynamic client registration (RFC 7591)
dynamic_registration_enabled = false
# Advertised scopes
supported_scopes = [
    "openid",
    "fhirUser",
    "launch",
    "launch/patient",
    "launch/encounter",
    "offline_access",
    "online_access",
    "patient/*.cruds",
    "user/*.cruds",
    "system/*.cruds",
]

[auth.signing]
# JWT signing algorithm: RS256, RS384, or ES384
# RS384 recommended for SMART on FHIR (faster than ES384, same security level)
algorithm = "RS384"
# Key rotation period in days
key_rotation_days = 90
# Number of old keys to retain for validation
keys_to_keep = 3

# Optional: Provide your own signing keys to persist tokens across server restarts
# If not set, a new key will be generated on each server start (tokens will be invalidated)
#
# To generate RSA keys (for RS256 or RS384) in PKCS#8 format:
#   openssl genpkey -algorithm RSA -out private.pem -pkeyopt rsa_keygen_bits:2048
#   openssl rsa -in private.pem -pubout -out public.pem
#
# To generate EC keys (for ES384) in PKCS#8 format:
#   openssl genpkey -algorithm EC -pkeyopt ec_paramgen_curve:P-384 -out private.pem
#   openssl ec -in private.pem -pubout -out public.pem
#
# Note: Keys must be in PKCS#8 format (-----BEGIN PRIVATE KEY-----), not traditional format.
# If you have a key in traditional format, convert it:
#   openssl pkcs8 -topk8 -nocrypt -in old_private.pem -out private.pem
#
# Then paste the contents (including BEGIN/END markers) below:
#
# private_key_pem = """
# -----BEGIN PRIVATE KEY-----
# ...
# -----END PRIVATE KEY-----
# """
#
# public_key_pem = """
# -----BEGIN PUBLIC KEY-----
# ...
# -----END PUBLIC KEY-----
# """
#
# Optional: Set a stable key ID (recommended when using fixed keys)
kid = "dev-rs384-key-2024"

private_key_pem = """
-----BEGIN PRIVATE KEY-----
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
s2/3NHMCpWMgbDMTc4gCvQ==
-----END PRIVATE KEY-----
"""

public_key_pem = """
-----BEGIN PUBLIC KEY-----
MIIBojANBgkqhkiG9w0BAQEFAAOCAY8AMIIBigKCAYEA3If+vBz3iNSdXi5oYJVX
/eJjcDw3xF7rJiJOocHmopxF/jj7SoS6aJRFkOvbV0eaVAJrKY7UGo6kXNPgXHp2
0cTpzLtgp6D9sxJMmmdlFI1IHslKRY6RBsVeFNqdB3/0YVwE4oJH2LwL5Ri98XOt
GyKe6IcTDGYBKjwFh3FJwlpHoGKGfEpYIMdr6vQ1HlkIZcTcJ51dTvNaJ+Hbi4ke
YYCJYDDaftlepLZ4v13az0HVWygLzKDgpRObl401QVtCWw3f95p50Frax4Gwz3Cd
WOU09m7h7ob49CuEfzS59iRsfYHEuDho6hLzYysImnb2ymjFWF5GbUpK+/gXucbJ
L1zhoWXdcbi6jy59zzH1QR2YsXT+Ajd1JPHnZOpvIqgzjbCURdhllbnvh1FOK9Ea
cfVJD41kWY5LtbNUZPqzFa8dkJ/UYnNCZ960UO7/Q2KjbekbMzsEDsFSRqsKtdQW
N7NX+uwIu7552bYOe6hakPDbgGdVi9nfKIsMxv1RTxKVAgMBAAE=
-----END PUBLIC KEY-----
"""

[auth.policy]
# Default policy decision when no policy matches
default_deny = true
# Enable QuickJS script engine for policies
quickjs_enabled = true

[auth.policy.quickjs]
memory_limit_mb = 16
max_stack_size_kb = 256
timeout_ms = 100

[auth.federation]
# Allow tokens from external identity providers
allow_external_idp = true
# Automatically create users from federated IdP claims
auto_provision_users = false
# JWKS cache TTL for external IdPs
jwks_cache_ttl = "1h"
jwks_refresh_on_failure = true

[auth.rate_limiting]
# Token endpoint rate limits
token_requests_per_minute = 60
token_requests_per_hour = 1000
# Authorization endpoint rate limits
auth_requests_per_minute = 30
# Lockout settings
max_failed_attempts = 5
lockout_duration = "5m"

[auth.cookie]
# Cookie-based authentication for browser clients
enabled = true
name = "octofhir_token"
secure = false  # Set to true in production with HTTPS
http_only = true
same_site = "lax"  # "lax" allows cross-site navigation, "none" requires secure=true
path = "/"
# domain is optional - defaults to current domain

[auth.session]
# SSO session management for persistent authentication across OAuth flows
# Idle timeout: session extends on each activity (sliding window)
idle_timeout = "30m"
# Absolute timeout: maximum session lifetime regardless of activity
absolute_timeout = "8h"
# Maximum concurrent sessions per user (prevents session accumulation)
max_concurrent_sessions = 10
# Session cookie name
cookie_name = "octofhir_sso"
# Cookie security (should match auth.cookie.secure in production)
cookie_secure = false  # Set to true in production with HTTPS
cookie_same_site = "Lax"

# =============================================================================
# Redis Cache Configuration (for horizontal scaling)
# =============================================================================

[redis]
# Enable Redis caching (set to true for multi-instance deployments)
enabled = false
# Redis connection URL (matches docker-compose.yml configuration)
url = "redis://localhost:6380"
# Connection pool size
pool_size = 10
# Connection timeout in milliseconds
timeout_ms = 5000

# =============================================================================
# Terminology Server Configuration
# =============================================================================

[terminology]
# Remote terminology server for code validation and ValueSet expansion
# Defaults to tx.fhir.org if not specified
# server_url = "https://tx.fhir.org/r4"

# Cache TTL for terminology responses (default: 3600 = 1 hour)
# cache_ttl_secs = 3600

[cache]
# Terminology cache TTL in seconds (1 hour)
terminology_ttl_secs = 3600
# Local (L1) cache max entries
local_cache_max_entries = 10000

# =============================================================================
# DB Console Configuration (SQL execution and LSP)
# =============================================================================

[db_console]
# Enable DB console functionality
enabled = true
# SQL execution mode: "readonly" | "readwrite" | "admin"
sql_mode = "admin"
# Required role for DB console access (comment out for any authenticated user)
# required_role = "admin"
# Enable LSP features (autocomplete, hover, diagnostics)
lsp_enabled = true

# =============================================================================
# GraphQL Configuration (FHIR GraphQL API)
# =============================================================================

[graphql]
# Enable GraphQL endpoint at /$graphql (and /fhir/{type}/{id}/$graphql for instance queries)
enabled = true
# Enable introspection queries (__schema, __type)
# May want to disable in production for security
introspection = true
# Maximum query depth to prevent deeply nested queries
max_depth = 15
# Maximum query complexity score
max_complexity = 500

# =============================================================================
# Bootstrap Configuration (initial server setup)
# =============================================================================

[bootstrap.admin_user]
# Admin user created on first startup if not already exists
# Credentials can also be set via environment variables:
#   OCTOFHIR__BOOTSTRAP__ADMIN_USER__USERNAME
#   OCTOFHIR__BOOTSTRAP__ADMIN_USER__PASSWORD
#   OCTOFHIR__BOOTSTRAP__ADMIN_USER__EMAIL
username = "admin"
password = "admin123"
email = "admin@octofhir.io"

[bootstrap.backend_client]
client_id = "backend"
client_secret = "dev-secret-2024"
scopes = ["system/*.cruds"]
name = "Backend Service"
description = "Backend service client"

# =============================================================================
# SQL on FHIR Configuration (ViewDefinition Editor)
# =============================================================================

[sql_on_fhir]
# Enable SQL on FHIR feature
# When enabled:
# - Installs SQL on FHIR IG package (hl7.fhir.uv.sql-on-fhir)
# - Enables ViewDefinition CRUD operations via FHIR API
# - Enables $run operation to execute ViewDefinitions
# - Enables $export operation for CSV/Parquet/NDJSON export
enabled = true

# =============================================================================
# Audit Trail Configuration
# =============================================================================

[audit]
# Enable audit trail logging (creates AuditEvent resources)
enabled = false
# Log FHIR resource operations (create, read, update, delete, search)
log_fhir_operations = true
# Log authentication events (login, logout, failed attempts)
log_auth_events = true
# Log read operations (GET requests) - can generate high volume
log_read_operations = true
# Log search operations - can generate high volume
log_search_operations = true
# Resource types to exclude from audit logging (to avoid loops)
exclude_resource_types = ["AuditEvent"]
